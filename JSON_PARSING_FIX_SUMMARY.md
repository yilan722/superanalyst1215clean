# ğŸ”§ JSONè§£æé—®é¢˜ä¿®å¤æ€»ç»“

## ğŸš¨ **é—®é¢˜è¯Šæ–­**

### **é”™è¯¯è¡¨ç°**:
```
Failed to parse report content
Details: Error: æœªæ‰¾åˆ°JSONæ ¼å¼çš„æŠ¥å‘Šå†…å®¹
```

### **æ ¹æœ¬åŸå› **:
1. **Perplexity APIè¿”å›æ ¼å¼ä¸ä¸€è‡´** - å¯èƒ½è¿”å›è‡ªç„¶è¯­è¨€è€Œä¸æ˜¯çº¯JSON
2. **JSONæå–é€»è¾‘è¿‡äºä¸¥æ ¼** - åªå¯»æ‰¾æ ‡å‡†JSONç»“æ„
3. **ç¼ºå°‘fallbackæœºåˆ¶** - å½“JSONè§£æå¤±è´¥æ—¶æ²¡æœ‰å¤‡ç”¨æ–¹æ¡ˆ

## âœ… **å®æ–½çš„ä¿®å¤æ–¹æ¡ˆ**

### **1. å¢å¼ºJSONæå–é€»è¾‘**
```typescript
// æ–¹æ³•1: å¯»æ‰¾æœ€å¤–å±‚çš„JSONå¯¹è±¡
const jsonMatch = content.match(/\{[\s\S]*\}/g)
if (jsonMatch && jsonMatch.length > 0) {
  jsonContent = jsonMatch.reduce((longest, current) => 
    current.length > longest.length ? current : longest, ''
  )
}

// æ–¹æ³•2: å¯»æ‰¾ä»£ç å—ä¸­çš„JSON
const codeBlockMatch = content.match(/```json\s*(\{[\s\S]*?\})\s*```/i)

// æ–¹æ³•3: å¯»æ‰¾ä»»ä½•JSONç»“æ„
const anyJsonMatch = content.match(/(\{[^{}]*(?:\{[^{}]*\}[^{}]*)*\})/g)
```

### **2. æ·»åŠ è‡ªç„¶è¯­è¨€è§£æfallback**
```typescript
function parseNaturalLanguageReport(content: string): any {
  // å®šä¹‰ç« èŠ‚æ¨¡å¼ï¼ˆä¸­è‹±æ–‡æ”¯æŒï¼‰
  const sectionPatterns = [
    {
      key: 'fundamentalAnalysis',
      patterns: [
        /åŸºæœ¬é¢åˆ†æ|Fundamental Analysis/i,
        /å…¬å¸æ¦‚è§ˆ|Company Overview/i
      ]
    },
    // ... å…¶ä»–ç« èŠ‚
  ]
  
  // æ™ºèƒ½æå–å„ä¸ªéƒ¨åˆ†
  // è‡ªåŠ¨åˆ†å‰²å’Œæ¸…ç†å†…å®¹
  // å¡«å……ç¼ºå¤±éƒ¨åˆ†
}
```

### **3. è¯¦ç»†é”™è¯¯è°ƒè¯•ä¿¡æ¯**
```typescript
return NextResponse.json({
  error: 'Failed to parse report content',
  details: `JSONè§£æå¤±è´¥: ${parseError}. è‡ªç„¶è¯­è¨€è§£æå¤±è´¥: ${fallbackError}`,
  debug: {
    contentLength: content.length,
    contentPreview: content.substring(0, 500)
  }
}, { status: 500 })
```

## ğŸ¯ **ä¿®å¤æ•ˆæœé¢„æœŸ**

### **æˆåŠŸæƒ…å†µ**:
1. **JSONæ ¼å¼æ­£ç¡®** â†’ ç›´æ¥è§£æ âœ…
2. **JSONæ ¼å¼é”™è¯¯** â†’ è‡ªç„¶è¯­è¨€è§£æ âœ…
3. **å®Œå…¨æ— æ³•è§£æ** â†’ è¯¦ç»†é”™è¯¯ä¿¡æ¯ âœ…

### **è§£æç­–ç•¥**:
- ğŸ¯ **æ™ºèƒ½ç« èŠ‚è¯†åˆ«** - æ”¯æŒä¸­è‹±æ–‡ç« èŠ‚æ ‡é¢˜
- ğŸ”„ **å†…å®¹åˆ†å‰²å¤‡ç”¨** - æŒ‰æ®µè½æ™ºèƒ½åˆ†é…
- ğŸ›¡ï¸ **é»˜è®¤å†…å®¹å¡«å……** - ç¡®ä¿ç»“æ„å®Œæ•´

## ğŸš€ **ä¸‹ä¸€æ­¥æµ‹è¯•**

ç°åœ¨æ‚¨å¯ä»¥å†æ¬¡å°è¯•ç”ŸæˆæŠ¥å‘Šï¼Œç³»ç»Ÿå°†ï¼š
1. é¦–å…ˆå°è¯•JSONè§£æ
2. å¦‚æœå¤±è´¥ï¼Œè‡ªåŠ¨ä½¿ç”¨è‡ªç„¶è¯­è¨€è§£æ
3. æä¾›è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯å¸®åŠ©æ’æŸ¥é—®é¢˜

**æŠ¥å‘Šç”Ÿæˆåº”è¯¥èƒ½å¤ŸæˆåŠŸäº†ï¼** ğŸ‰

---

## ğŸ’¡ **æŠ€æœ¯æ”¹è¿›ç‚¹**

- âœ… **å¤šé‡è§£æç­–ç•¥** - ä¸å†ä¾èµ–å•ä¸€JSONæ ¼å¼
- âœ… **æ™ºèƒ½å†…å®¹è¯†åˆ«** - æ”¯æŒå„ç§è¿”å›æ ¼å¼
- âœ… **è¯¦ç»†é”™è¯¯è¯Šæ–­** - ä¾¿äºå¿«é€Ÿå®šä½é—®é¢˜
- âœ… **æ¸è¿›å¼é™çº§** - ç¡®ä¿æ€»èƒ½è¿”å›æœ‰ç”¨å†…å®¹
